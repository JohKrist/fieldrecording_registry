<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Fieldlog">
<meta name="theme-color" content="#0c0f0e">
<meta name="mobile-web-app-capable" content="yes">
<title>Field Recording Log</title>
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%230c0f0e'/><circle cx='90' cy='90' r='28' fill='none' stroke='%234ecdc4' stroke-width='4'/><circle cx='90' cy='90' r='8' fill='%234ecdc4'/></svg>">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRmllbGRsb2ciLCJzaG9ydF9uYW1lIjoiRmllbGRsb2ciLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBjMGYwZSIsInRoZW1lX2NvbG9yIjoiIzBjMGYwZSJ9">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600&display=swap');

:root {
  --bg: #0c0f0e;
  --bg2: #111514;
  --bg3: #161b19;
  --border: #1e2624;
  --border2: #263330;
  --text: #c8d5d0;
  --text-bright: #e0ece8;
  --text-dim: #5a6e68;
  --accent: #4ecdc4;
  --accent-dim: rgba(78,205,196,0.15);
  --accent-glow: rgba(78,205,196,0.25);
  --warm: #e8a838;
  --danger: #c45040;
  --danger-dim: rgba(196,80,64,0.15);
  --radius: 12px;
  --radius-sm: 8px;
  --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
  --font-sans: 'Inter', -apple-system, sans-serif;
  --safe-b: env(safe-area-inset-bottom, 0px);
  --safe-t: env(safe-area-inset-top, 0px);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: var(--font-mono);
  background: var(--bg);
  color: var(--text);
  height: 100dvh;
  overflow: hidden;
  touch-action: manipulation;
}

#app {
  display: flex; flex-direction: column;
  height: 100dvh; position: relative;
}

header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 20px; padding-top: max(14px, var(--safe-t));
  background: var(--bg); z-index: 20; flex-shrink: 0;
  border-bottom: 1px solid var(--border);
}
.h-left { display:flex; align-items:center; gap:12px; }
.logo {
  width: 28px; height: 28px; border-radius: 50%;
  border: 2px solid var(--accent); display:flex;
  align-items:center; justify-content:center;
  box-shadow: 0 0 16px var(--accent-glow);
}
.logo-dot { width:8px; height:8px; border-radius:50%; background:var(--accent); }
.h-title { font-size:13px; font-weight:700; letter-spacing:0.18em; color:var(--text-bright); }
.h-sub { font-size:10px; color:var(--text-dim); letter-spacing:0.05em; display:block; margin-top:1px; }
.h-btn {
  background:var(--bg3); border:1px solid var(--border2); color:var(--text);
  font-family:var(--font-mono); font-size:11px; padding:7px 16px;
  border-radius:var(--radius-sm); cursor:pointer;
}

main {
  flex:1; overflow-y:auto; overflow-x:hidden;
  position:relative; -webkit-overflow-scrolling:touch;
}

.view { display:none; }
.view.active { display:block; }

.stats-bar {
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:1px; background:var(--border); margin:16px;
  border-radius:var(--radius); overflow:hidden;
}
.stat-card { background:var(--bg2); padding:16px 12px; text-align:center; }
.stat-val {
  font-size:22px; font-weight:700; color:var(--accent);
  font-family:var(--font-mono); line-height:1;
}
.stat-label {
  font-size:9px; text-transform:uppercase; letter-spacing:0.1em;
  color:var(--text-dim); margin-top:6px; font-family:var(--font-sans);
}

.list-wrap { padding:0 16px 120px; }
.list-actions {
  display:flex; justify-content:flex-end; gap:8px;
  padding:8px 0; position:sticky; top:0;
  background:var(--bg); z-index:5;
}
.sm-btn {
  background:var(--bg2); border:1px solid var(--border);
  color:var(--text-dim); font-family:var(--font-mono);
  font-size:10px; padding:6px 12px; border-radius:6px;
  cursor:pointer; letter-spacing:0.03em; transition:all 0.15s;
}
.sm-btn:active { background:var(--bg3); color:var(--text); }

.rec-card {
  display:flex; align-items:stretch; gap:0;
  background:var(--bg2); border:1px solid var(--border);
  border-radius:var(--radius); cursor:pointer;
  color:var(--text); font-family:inherit; width:100%;
  text-align:left; overflow:hidden; margin-bottom:10px;
  transition:border-color 0.15s;
}
.rec-card:active { border-color:var(--border2); }
.rec-thumb { width:80px; min-height:80px; object-fit:cover; flex-shrink:0; }
.rec-thumb-ph {
  width:80px; min-height:80px; flex-shrink:0;
  background:var(--bg3); display:flex; align-items:center;
  justify-content:center; color:var(--accent); opacity:0.25; font-size:20px;
}
.rec-body { padding:12px 14px; flex:1; min-width:0; display:flex; flex-direction:column; justify-content:center; }
.rec-title {
  font-size:13px; font-family:var(--font-sans); font-weight:600;
  line-height:1.35; color:var(--text-bright);
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.rec-location {
  font-size:10px; color:var(--accent); margin-top:3px;
  font-family:var(--font-mono); opacity:0.8;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.rec-meta {
  font-size:10px; color:var(--text-dim); margin-top:4px;
  display:flex; align-items:center; gap:6px; font-family:var(--font-mono);
}
.rec-dot { opacity:0.3; }
.rec-weather { font-size:10px; color:var(--text-dim); margin-top:3px; font-family:var(--font-sans); }

.empty {
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; padding:80px 40px; text-align:center;
}
.empty-ring {
  width:60px; height:60px; border-radius:50%;
  border:2px solid var(--border2); display:flex;
  align-items:center; justify-content:center; margin-bottom:20px;
}
.empty-ring-dot { width:12px; height:12px; border-radius:50%; background:var(--accent); opacity:0.2; }
.empty-t { font-size:14px; color:var(--text); font-family:var(--font-sans); font-weight:500; }
.empty-s { font-size:12px; color:var(--text-dim); margin-top:8px; font-family:var(--font-sans); }

.map-wrap { width:100%; height:100%; position:absolute; top:0; left:0; }
#mainMap { width:100%; height:100%; }

.add-form { padding:20px; display:flex; flex-direction:column; gap:14px; padding-bottom:40px; }
.photo-box {
  width:100%; aspect-ratio:16/10; border-radius:var(--radius);
  overflow:hidden; border:1.5px dashed var(--border2); cursor:pointer;
  background:var(--bg2); position:relative;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  transition:border-color 0.2s;
}
.photo-box:active { border-color:var(--accent); }
.photo-box img { width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; }
.photo-ph { display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-dim); }
.photo-ph-icon { font-size:28px; }
.photo-ph-text { font-size:11px; font-family:var(--font-sans); }

.field-group { position:relative; }
.field-label {
  font-size:9px; text-transform:uppercase; letter-spacing:0.1em;
  color:var(--text-dim); margin-bottom:6px; display:block;
}
input[type="text"], textarea {
  width:100%; background:var(--bg2); border:1px solid var(--border);
  border-radius:var(--radius-sm); padding:14px 16px; color:var(--text);
  font-family:var(--font-sans); font-size:14px; line-height:1.5;
  outline:none; transition:border-color 0.2s;
}
input[type="text"] { line-height:1.2; }
textarea { resize:none; }
input::placeholder, textarea::placeholder { color:var(--text-dim); opacity:0.5; }
input:focus, textarea:focus { border-color:var(--accent); }

.info-row {
  display:flex; align-items:center; gap:10px;
  padding:12px 14px; background:var(--bg2);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  font-size:12px;
}
.info-icon { font-size:14px; flex-shrink:0; }
.info-text { flex:1; }
.pulse-dot {
  width:8px; height:8px; border-radius:50%;
  background:var(--accent); animation:pulse 1.5s ease infinite;
}

.save-btn {
  width:100%; padding:16px; background:var(--accent); color:var(--bg);
  border:none; border-radius:var(--radius); font-family:var(--font-mono);
  font-size:13px; font-weight:700; letter-spacing:0.08em;
  cursor:pointer; margin-top:4px; transition:opacity 0.2s;
}
.save-btn:disabled { opacity:0.25; }
.save-btn:active:not(:disabled) { opacity:0.8; }

.detail-wrap { padding-bottom:40px; }
.detail-photo { width:100%; max-height:280px; object-fit:cover; border-bottom:1px solid var(--border); }
.detail-body { padding:20px; }
.detail-title {
  font-size:20px; font-family:var(--font-sans); font-weight:600;
  line-height:1.3; color:var(--text-bright); margin-bottom:4px;
}
.detail-loc {
  font-size:12px; color:var(--accent); font-family:var(--font-mono);
  margin-bottom:16px; opacity:0.8;
}
.detail-desc {
  font-size:14px; font-family:var(--font-sans); font-weight:400;
  line-height:1.6; color:var(--text); margin-bottom:20px;
  white-space:pre-wrap;
}
.detail-grid {
  display:grid; grid-template-columns:1fr 1fr;
  gap:2px; background:var(--border); border-radius:var(--radius);
  overflow:hidden; margin-bottom:20px;
}
.detail-cell { background:var(--bg2); padding:14px; }
.detail-cell-full { grid-column:1/-1; }
.d-label {
  font-size:9px; text-transform:uppercase; letter-spacing:0.1em;
  color:var(--text-dim); margin-bottom:4px; display:block;
}
.d-val { font-size:12px; color:var(--text-bright); font-family:var(--font-mono); }
.d-val-accent { color:var(--accent); }

.detail-minimap {
  width:100%; height:180px; border-radius:var(--radius);
  overflow:hidden; border:1px solid var(--border); margin-bottom:20px;
}

.del-btn {
  background:var(--danger-dim); border:1px solid rgba(196,80,64,0.25);
  color:var(--danger); font-family:var(--font-mono); font-size:11px;
  padding:12px; border-radius:var(--radius-sm); cursor:pointer; width:100%;
}

nav {
  position:absolute; bottom:0; left:0; right:0;
  display:flex; align-items:center; justify-content:space-around;
  padding:10px 20px; padding-bottom:max(16px, var(--safe-b));
  background:linear-gradient(transparent, var(--bg) 35%);
  z-index:20;
}
.nav-btn {
  background:none; border:none; color:var(--text);
  display:flex; flex-direction:column; align-items:center;
  gap:4px; cursor:pointer; padding:8px 24px;
  font-family:var(--font-mono); transition:opacity 0.15s;
}
.nav-icon { font-size:18px; }
.nav-label { font-size:9px; text-transform:uppercase; letter-spacing:0.1em; }
.fab {
  width:54px; height:54px; border-radius:50%;
  background:var(--accent); border:none; color:var(--bg);
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  box-shadow:0 4px 24px var(--accent-glow);
  font-size:26px; font-weight:700; transition:transform 0.15s;
}
.fab:active { transform:scale(0.92); }
button:active { transform:scale(0.97); }

.leaflet-control-attribution { font-size:8px!important; opacity:0.4; }
.leaflet-control-zoom a {
  background:var(--bg2)!important; color:var(--text)!important;
  border-color:var(--border)!important;
}

@keyframes pulse {
  0%,100% { opacity:1; transform:scale(1); }
  50% { opacity:0.4; transform:scale(0.8); }
}
@keyframes fadeIn {
  from { opacity:0; transform:translateY(8px); }
  to { opacity:1; transform:translateY(0); }
}
.fade-in { animation:fadeIn 0.3s ease both; }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="h-left">
      <div class="logo"><div class="logo-dot"></div></div>
      <div>
        <div class="h-title">FIELDLOG</div>
        <span class="h-sub" id="counter">0 recordings</span>
      </div>
    </div>
    <button class="h-btn" id="hBtn" style="display:none" onclick="goBack()"></button>
  </header>

  <main>
    <div class="view active" id="vList">
      <div id="statsBar"></div>
      <div class="list-wrap" id="listWrap"></div>
    </div>
    <div class="view map-wrap" id="vMap"><div id="mainMap"></div></div>
    <div class="view" id="vAdd"></div>
    <div class="view" id="vDetail"></div>
  </main>

  <nav id="bnav">
    <button class="nav-btn" id="navList" onclick="go('list')" style="opacity:1">
      <span class="nav-icon">☰</span><span class="nav-label">List</span>
    </button>
    <button class="fab" onclick="startAdd()">+</button>
    <button class="nav-btn" id="navMap" onclick="go('map')" style="opacity:0.4">
      <span class="nav-icon">◎</span><span class="nav-label">Map</span>
    </button>
  </nav>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const SK='fieldlog-v3';
let recs=[],curView='list',curPhoto=null,curLoc=null,curWeather=null,curPlace=null;
let mainMap=null,mainMarkers=[],detailMap=null,timerIv=null;

function load(){try{const d=localStorage.getItem(SK);if(d)recs=JSON.parse(d)}catch(e){}}
function save(){try{localStorage.setItem(SK,JSON.stringify(recs))}catch(e){}}

function fmtDate(iso){return new Date(iso).toLocaleDateString('en-GB',{weekday:'short',year:'numeric',month:'short',day:'numeric'})}
function fmtTime(iso){return new Date(iso).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}
function fmtShort(iso){return new Date(iso).toLocaleDateString('en-GB',{day:'numeric',month:'short'})}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function today(){return new Date().toISOString().split('T')[0]}

function resizeImg(url,mx=800){
  return new Promise(r=>{const i=new Image();i.onload=()=>{
    const c=document.createElement('canvas'),s=Math.min(mx/i.width,mx/i.height,1);
    c.width=i.width*s;c.height=i.height*s;
    c.getContext('2d').drawImage(i,0,0,c.width,c.height);
    r(c.toDataURL('image/jpeg',0.7));};i.src=url;});
}

function windDir(deg){
  const d=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return d[Math.round(deg/22.5)%16];
}
function beaufort(ms){
  const b=[0.3,1.6,3.4,5.5,8,10.8,13.9,17.2,20.8,24.5,28.5,32.7];
  for(let i=0;i<b.length;i++) if(ms<b[i]) return i; return 12;
}

// Weather via Open-Meteo
async function fetchWeather(lat,lng){
  try{
    const u='https://api.open-meteo.com/v1/forecast?latitude='+lat+'&longitude='+lng+'&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,weather_code&timezone=auto';
    const r=await fetch(u,{signal:AbortSignal.timeout(8000)});
    const d=await r.json(),c=d.current;
    return{temp:Math.round(c.temperature_2m),humidity:c.relative_humidity_2m,
      windSpeed:c.wind_speed_10m,windDir:windDir(c.wind_direction_10m),
      windDirDeg:c.wind_direction_10m,beaufort:beaufort(c.wind_speed_10m/3.6),code:c.weather_code};
  }catch(e){return null;}
}

// Reverse geocode via Nominatim (free, no key)
async function reverseGeocode(lat,lng){
  try{
    const u='https://nominatim.openstreetmap.org/reverse?format=json&lat='+lat+'&lon='+lng+'&zoom=14&addressdetails=1';
    const r=await fetch(u,{signal:AbortSignal.timeout(8000),headers:{'Accept-Language':'en'}});
    const d=await r.json();
    const a=d.address;
    // Build a nice place name: village/city/town + municipality/county
    const place=a.village||a.town||a.city||a.hamlet||a.suburb||'';
    const region=a.municipality||a.county||a.state||'';
    if(place&&region&&place!==region) return place+', '+region;
    return place||region||d.display_name?.split(',').slice(0,2).join(',')||'';
  }catch(e){return null;}
}

function wxIcon(code){
  if(code<=1)return'\u2600\uFE0F';if(code<=3)return'\u26C5';if(code<=48)return'\uD83C\uDF2B\uFE0F';
  if(code<=67)return'\uD83C\uDF27\uFE0F';if(code<=77)return'\uD83C\uDF28\uFE0F';
  if(code<=82)return'\uD83C\uDF27\uFE0F';if(code<=86)return'\uD83C\uDF28\uFE0F';return'\u26C8\uFE0F';
}
function wxShort(w){if(!w)return'';return wxIcon(w.code)+' '+w.temp+'\u00B0C \u00B7 '+w.windDir+' Bf'+w.beaufort;}
function wxFull(w){if(!w)return'';return wxIcon(w.code)+' '+w.temp+'\u00B0C, wind '+w.windDir+' ('+w.windDirDeg+'\u00B0) '+w.windSpeed+' km/h Bf'+w.beaufort+', RH '+w.humidity+'%';}

// View management
function go(name){
  curView=name;
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('bnav').style.display='';
  document.getElementById('hBtn').style.display='none';
  if(name==='list'){
    document.getElementById('vList').classList.add('active');
    navList.style.opacity='1';navMap.style.opacity='0.4';
    renderStats();renderList();
  }else if(name==='map'){
    document.getElementById('vMap').classList.add('active');
    navList.style.opacity='0.4';navMap.style.opacity='1';
    setTimeout(initMainMap,120);
  }else if(name==='add'){
    document.getElementById('vAdd').classList.add('active');
    document.getElementById('bnav').style.display='none';
    document.getElementById('hBtn').style.display='';
    document.getElementById('hBtn').textContent='cancel';
  }else if(name==='detail'){
    document.getElementById('vDetail').classList.add('active');
    document.getElementById('bnav').style.display='none';
    document.getElementById('hBtn').style.display='';
    document.getElementById('hBtn').textContent='\u2190 back';
  }
  updCtr();
}
function goBack(){if(timerIv){clearInterval(timerIv);timerIv=null;}go('list');}
function updCtr(){document.getElementById('counter').textContent=recs.length+' recording'+(recs.length!==1?'s':'');}

// Stats
function renderStats(){
  const el=document.getElementById('statsBar');
  if(!recs.length){el.innerHTML='';return;}
  const wl=recs.filter(r=>r.lat).length;
  const n=new Date();
  const mo=recs.filter(r=>{const d=new Date(r.timestamp);return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear();}).length;
  el.innerHTML='<div class="stats-bar fade-in"><div class="stat-card"><div class="stat-val">'+recs.length+'</div><div class="stat-label">Total</div></div><div class="stat-card"><div class="stat-val">'+mo+'</div><div class="stat-label">This month</div></div><div class="stat-card"><div class="stat-val">'+wl+'</div><div class="stat-label">With location</div></div></div>';
}

// List
function renderList(){
  const el=document.getElementById('listWrap');
  if(!recs.length){
    el.innerHTML='<div class="empty"><div class="empty-ring"><div class="empty-ring-dot"></div></div><p class="empty-t">No recordings yet</p><p class="empty-s">Tap + to log your first field recording</p></div>';
    return;
  }
  let h='<div class="list-actions"><button class="sm-btn" onclick="exportCSV()">\u2193 CSV</button><button class="sm-btn" onclick="exportGeoJSON()">\u2193 GeoJSON</button></div>';
  recs.forEach((r,i)=>{
    const th=r.photo?'<img src="'+r.photo+'" class="rec-thumb" alt="">':'<div class="rec-thumb-ph">\u25CE</div>';
    const ws=r.weather?'<div class="rec-weather">'+wxShort(r.weather)+'</div>':'';
    const loc=r.placeName?'<div class="rec-location">\u25C9 '+esc(r.placeName)+'</div>':'';
    const title=r.title?esc(r.title):(r.description?esc(r.description):'Untitled');
    h+='<button class="rec-card fade-in" style="animation-delay:'+i*0.04+'s" onclick="showDetail(\''+r.id+'\')">'+th+'<div class="rec-body"><div class="rec-title">'+title+'</div>'+loc+'<div class="rec-meta"><span>'+fmtShort(r.timestamp)+'</span><span class="rec-dot">\u00B7</span><span>'+fmtTime(r.timestamp)+'</span></div>'+ws+'</div></button>';
  });
  el.innerHTML=h;
}

// Detail
function showDetail(id){
  const r=recs.find(x=>x.id===id);if(!r)return;
  let h='<div class="detail-wrap fade-in">';
  if(r.photo)h+='<img src="'+r.photo+'" class="detail-photo" alt="">';
  h+='<div class="detail-body">';
  h+='<div class="detail-title">'+esc(r.title||'Untitled')+'</div>';
  if(r.placeName)h+='<div class="detail-loc">\u25C9 '+esc(r.placeName)+'</div>';
  else h+='<div style="margin-bottom:12px"></div>';
  if(r.description)h+='<div class="detail-desc">'+esc(r.description)+'</div>';
  h+='<div class="detail-grid"><div class="detail-cell"><span class="d-label">Date</span><span class="d-val">'+fmtDate(r.timestamp)+'</span></div><div class="detail-cell"><span class="d-label">Time</span><span class="d-val">'+fmtTime(r.timestamp)+'</span></div>';
  if(r.lat)h+='<div class="detail-cell"><span class="d-label">Coordinates</span><span class="d-val d-val-accent">'+r.lat.toFixed(6)+', '+r.lng.toFixed(6)+'</span></div><div class="detail-cell"><span class="d-label">Accuracy</span><span class="d-val">\u00B1'+Math.round(r.accuracy||0)+'m</span></div>';
  if(r.weather)h+='<div class="detail-cell detail-cell-full"><span class="d-label">Weather conditions</span><span class="d-val">'+wxFull(r.weather)+'</span></div>';
  h+='</div>';
  if(r.lat)h+='<div class="detail-minimap" id="detailMinimap"></div>';
  h+='<button class="del-btn" onclick="delRec(\''+r.id+'\')">Delete recording</button></div></div>';
  document.getElementById('vDetail').innerHTML=h;
  go('detail');
  if(r.lat){
    setTimeout(()=>{
      if(detailMap){detailMap.remove();detailMap=null;}
      const el=document.getElementById('detailMinimap');if(!el)return;
      detailMap=L.map(el,{zoomControl:false,attributionControl:false,dragging:false,scrollWheelZoom:false}).setView([r.lat,r.lng],15);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(detailMap);
      const ic=L.divIcon({className:'x',html:'<div style="width:18px;height:18px;background:#4ecdc4;border:3px solid #0c0f0e;border-radius:50%;box-shadow:0 0 12px rgba(78,205,196,0.4)"></div>',iconSize:[18,18],iconAnchor:[9,9]});
      L.marker([r.lat,r.lng],{icon:ic}).addTo(detailMap);
      setTimeout(()=>detailMap.invalidateSize(),200);
    },200);
  }
}

function delRec(id){if(!confirm('Delete this recording?'))return;recs=recs.filter(r=>r.id!==id);save();go('list');}

// Add
function startAdd(){
  curPhoto=null;curLoc=null;curWeather=null;curPlace=null;
  document.getElementById('vAdd').innerHTML=`
    <div class="add-form fade-in">
      <div class="photo-box" onclick="document.getElementById('camIn').click()">
        <div class="photo-ph" id="photoPh">
          <span class="photo-ph-icon">\uD83D\uDCF7</span>
          <span class="photo-ph-text">tap to take photo</span>
        </div>
        <img id="photoImg" style="display:none" alt="">
        <input type="file" id="camIn" accept="image/*" capture="environment" style="display:none" onchange="onPhoto(event)">
      </div>

      <div class="field-group">
        <label class="field-label">Title</label>
        <input type="text" id="titleIn" placeholder="e.g. Dawn chorus at the river bend" maxlength="100">
      </div>

      <div class="field-group">
        <label class="field-label">Description</label>
        <textarea id="descIn" placeholder="Environment, sound sources, conditions, equipment notes..." rows="3"></textarea>
      </div>

      <div class="info-row" id="locInfo">
        <div class="pulse-dot"></div>
        <span class="info-text">Getting location...</span>
      </div>

      <div class="info-row" id="placeInfo" style="display:none">
        <span class="info-icon" style="color:var(--accent)">\u25C9</span>
        <span class="info-text" id="placeText"></span>
      </div>

      <div class="info-row" id="wxInfo" style="display:none">
        <span class="info-icon">\uD83C\uDF21\uFE0F</span>
        <span class="info-text" id="wxText"></span>
      </div>

      <div class="info-row">
        <span class="info-icon" style="opacity:0.4">\u23F1</span>
        <span class="info-text" id="timeText"></span>
      </div>

      <button class="save-btn" id="saveBtn" disabled onclick="doSave()">Save recording</button>
    </div>`;
  go('add');getLoc();updTime();
  timerIv=setInterval(updTime,1000);
  document.getElementById('titleIn').addEventListener('input',chkSave);
  document.getElementById('descIn').addEventListener('input',chkSave);
}

function updTime(){const el=document.getElementById('timeText');if(el){const n=new Date().toISOString();el.textContent=fmtDate(n)+' '+fmtTime(n);}}

function onPhoto(e){
  const f=e.target.files[0];if(!f)return;
  const rd=new FileReader();
  rd.onload=async ev=>{
    curPhoto=await resizeImg(ev.target.result);
    document.getElementById('photoImg').src=curPhoto;
    document.getElementById('photoImg').style.display='';
    document.getElementById('photoPh').style.display='none';
    chkSave();
  };rd.readAsDataURL(f);
}

function chkSave(){
  const t=document.getElementById('titleIn'),d=document.getElementById('descIn'),b=document.getElementById('saveBtn');
  if(t&&d&&b) b.disabled=!t.value.trim()&&!d.value.trim()&&!curPhoto;
}

function getLoc(){
  const el=document.getElementById('locInfo');
  if(!navigator.geolocation){el.innerHTML='<span style="color:var(--danger)">\u2715</span><span style="color:var(--danger)">Geolocation not available</span>';return;}
  el.innerHTML='<div class="pulse-dot"></div><span class="info-text">Getting location...</span>';
  navigator.geolocation.getCurrentPosition(
    async pos=>{
      curLoc={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy};
      el.innerHTML='<span style="color:var(--accent)">\u25C9</span><span>'+curLoc.lat.toFixed(5)+', '+curLoc.lng.toFixed(5)+'</span><span style="opacity:0.35;font-size:10px">\u00B1'+Math.round(curLoc.accuracy)+'m</span>';

      // Reverse geocode
      const pEl=document.getElementById('placeInfo'),pTx=document.getElementById('placeText');
      pEl.style.display='flex'; pTx.textContent='Resolving location name...';
      curPlace=await reverseGeocode(curLoc.lat,curLoc.lng);
      if(curPlace){pTx.textContent=curPlace;}
      else{pEl.style.display='none';}

      // Weather
      const wEl=document.getElementById('wxInfo'),wTx=document.getElementById('wxText');
      wEl.style.display='flex';wTx.textContent='Fetching weather...';
      curWeather=await fetchWeather(curLoc.lat,curLoc.lng);
      if(curWeather){wTx.textContent=wxFull(curWeather);}
      else{wTx.textContent='No weather data (offline?)';wTx.style.opacity='0.4';}
    },
    err=>{
      const msg=err.code===1?'Location access denied':'Could not determine location';
      el.innerHTML='<span style="color:var(--danger)">\u2715</span><span style="color:var(--danger)">'+msg+'</span><button class="sm-btn" style="margin-left:auto" onclick="getLoc()">retry</button>';
    },
    {enableHighAccuracy:true,timeout:15000}
  );
}

async function doSave(){
  const title=document.getElementById('titleIn').value.trim();
  const desc=document.getElementById('descIn').value.trim();
  if(!title&&!desc&&!curPhoto)return;
  if(timerIv){clearInterval(timerIv);timerIv=null;}
  recs.unshift({
    id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),
    timestamp:new Date().toISOString(),
    title:title,
    description:desc,
    photo:curPhoto,
    lat:curLoc?.lat||null,lng:curLoc?.lng||null,accuracy:curLoc?.accuracy||null,
    placeName:curPlace||null,
    weather:curWeather||null
  });
  save();go('list');
}

// Main map
function initMainMap(){
  const geo=recs.filter(r=>r.lat&&r.lng);
  if(!geo.length){document.getElementById('mainMap').innerHTML='<div class="empty" style="height:100%"><p class="empty-t">No recordings with location</p></div>';return;}
  if(!mainMap){
    mainMap=L.map('mainMap',{zoomControl:true}).setView([50.85,4.35],9);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM &copy; CARTO',maxZoom:19}).addTo(mainMap);
  }
  mainMarkers.forEach(m=>mainMap.removeLayer(m));mainMarkers=[];
  geo.forEach(r=>{
    const ic=L.divIcon({className:'x',html:'<div style="width:14px;height:14px;background:#4ecdc4;border:2px solid #0c0f0e;border-radius:50%;box-shadow:0 0 10px rgba(78,205,196,0.35)"></div>',iconSize:[14,14],iconAnchor:[7,7]});
    const popupContent='<div style="font-family:monospace;font-size:11px;max-width:200px"><strong>'+esc(r.title||r.description||'Untitled')+'</strong>'+(r.placeName?'<br><span style="color:#4ecdc4">'+esc(r.placeName)+'</span>':'')+'<br><span style="opacity:0.6">'+fmtDate(r.timestamp)+'</span>'+(r.weather?'<br><span style="opacity:0.6">'+wxShort(r.weather)+'</span>':'')+'</div>';
    const m=L.marker([r.lat,r.lng],{icon:ic}).addTo(mainMap).bindPopup(popupContent);
    m.on('click',()=>showDetail(r.id));
    mainMarkers.push(m);
  });
  mainMap.fitBounds(L.latLngBounds(geo.map(r=>[r.lat,r.lng])),{padding:[40,40],maxZoom:15});
  setTimeout(()=>mainMap.invalidateSize(),200);
}

// Export
function exportCSV(){
  if(!recs.length)return;
  const hdr='id,date,time,title,description,location_name,latitude,longitude,accuracy_m,temp_c,wind_kmh,wind_dir,beaufort,humidity_pct';
  const rows=recs.map(r=>{const d=new Date(r.timestamp),w=r.weather||{};
    return[r.id,d.toISOString().split('T')[0],d.toTimeString().split(' ')[0],
      '"'+(r.title||'').replace(/"/g,'""')+'"',
      '"'+(r.description||'').replace(/"/g,'""')+'"',
      '"'+(r.placeName||'').replace(/"/g,'""')+'"',
      r.lat||'',r.lng||'',r.accuracy?Math.round(r.accuracy):'',
      w.temp??'',w.windSpeed??'',w.windDir??'',w.beaufort??'',w.humidity??''].join(',');
  });
  dl(hdr+'\n'+rows.join('\n'),'fieldlog_'+today()+'.csv','text/csv');
}

function exportGeoJSON(){
  const geo=recs.filter(r=>r.lat&&r.lng);
  if(!geo.length){alert('No recordings with location data');return;}
  const fc={type:'FeatureCollection',features:geo.map(r=>{const w=r.weather||{};
    return{type:'Feature',geometry:{type:'Point',coordinates:[r.lng,r.lat]},
      properties:{id:r.id,title:r.title||'',description:r.description||'',
        location_name:r.placeName||'',
        date:new Date(r.timestamp).toISOString().split('T')[0],
        time:new Date(r.timestamp).toTimeString().split(' ')[0],
        accuracy_m:r.accuracy?Math.round(r.accuracy):null,
        temp_c:w.temp??null,wind_kmh:w.windSpeed??null,wind_dir:w.windDir??null,
        beaufort:w.beaufort??null,humidity_pct:w.humidity??null}};
  })};
  dl(JSON.stringify(fc,null,2),'fieldlog_'+today()+'.geojson','application/json');
}

function dl(content,name,mime){
  const b=new Blob([content],{type:mime}),u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download=name;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);
}

// Service Worker
if('serviceWorker' in navigator){
  const swCode="const CACHE='fieldlog-v3';const ASSETS=['./','https://unpkg.com/leaflet@1.9.4/dist/leaflet.css','https://unpkg.com/leaflet@1.9.4/dist/leaflet.js','https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600&display=swap'];self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting())));self.addEventListener('activate',e=>e.waitUntil(clients.claim()));self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(resp=>{if(resp.ok&&e.request.method==='GET'){const cl=resp.clone();caches.open(CACHE).then(c=>c.put(e.request,cl));}return resp;}).catch(()=>new Response('Offline',{status:503}))));});";
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode],{type:'application/javascript'}))).catch(()=>{});
}

load();renderStats();renderList();updCtr();
</script>
</body>
</html>
